# app/prompts/analysis_prompt.py

def get_analysis_prompt(transcript, language="ru"):
    """
    Возвращает промпт для анализа звонка с новой структурой оценки
    
    Args:
        transcript (str): Текст транскрипции звонка
        language (str): Язык для анализа (ru, kk)
        
    Returns:
        str: Готовый промпт для отправки в LLM
    """
    # Выбираем шаблон промпта на основе языка
    if language == "kk":
        return f"""
Мынадай сатушы мен тұтынушы арасындағы қоңырау транскрипциясын талдаңыз және толық талдау жасаңыз.
0-ден 10-ға дейін мына аспектілерді бағалаңыз:
1. Сату скриптін сақтау (script_adherence)
2. Белсенді тыңдау (active_listening)
3. Қарсылықтармен жұмыс (objection_handling)
4. Сату техникаларын қолдану (sales_techniques)
5. Қарым-қатынас этикасы (communication_ethics)

МАҢЫЗДЫ: Егер тұтынушы қоңырау кезінде қарсылық білдірмеген болса, "objection_handling" критерийіне сан бағасы орнына null қойыңыз және "Тұтынушы қарсылық білдірмеді" деп түсіндіріңіз.

Сонымен қатар мыналарды көрсетіңіз:
- Әңгіме кезеңдері бойынша талдау (greeting, needs_identification, presentation, objection_handling, closing)
- Әңгімедегі 3-5 ең жақсы сәттер мен комментарийлер
- 3-5 жақсартуды қажет ететін сәттер комментарийлермен
- Сатушы үшін 3-5 нақты ұсыныс

Қатесіз қоңырауларды жасауға нақты ұсыныстар қосыңыз. Әр проблемалық сәтке баламалы жақсартылған сөздер ұсыныңыз.

Нәтижені JSON форматында қайтарыңыз:
{{
    "analysis": {{
        "greeting": "Сәлемдесуді талдау",
        "needs_identification": "Қажеттіліктерді анықтауды талдау",
        "presentation": "Өнімді таныстыруды талдау",
        "objection_handling": "Қарсылықтармен жұмысты талдау",
        "closing": "Мәмілені аяқтауды талдау"
    }},
    "score": {{
        "script_adherence": {{
            "score": 0-10,
            "comment": "Бағаға түсіндірме"
        }},
        "active_listening": {{
            "score": 0-10,
            "comment": "Бағаға түсіндірме"
        }},
        "objection_handling": {{
            "score": 0-10 немесе null,
            "comment": "Бағаға түсіндірме"
        }},
        "sales_techniques": {{
            "score": 0-10,
            "comment": "Бағаға түсіндірме"
        }},
        "communication_ethics": {{
            "score": 0-10,
            "comment": "Бағаға түсіндірме"
        }}
    }},
    "best_moments": [
        {{
            "text": "Әңгімеден үзінді",
            "comment": "Неге бұл жақсы сәт"
        }}
    ],
    "worst_moments": [
        {{
            "text": "Әңгімеден үзінді",
            "comment": "Неге бұл проблемалық сәт",
            "recommendation": "Осының орнына не айту керек еді"
        }}
    ],
    "recommendations": [
        "Ұсыныс 1",
        "Ұсыныс 2"
    ]
}}

Транскрипция:
{transcript}
"""
    else:
        return f"""
Проанализируй следующую транскрипцию звонка продажника с клиентом и дай подробный анализ.
Оцени по шкале от 0 до 10 следующие аспекты:
1. Соблюдение скрипта продаж (script_adherence)
2. Активное слушание (active_listening)
3. Работа с возражениями (objection_handling)
4. Применение техник продаж (sales_techniques)
5. Этика общения (communication_ethics)

ВАЖНО: Если клиент не выдвигал возражений во время звонка, то для критерия "objection_handling" 
поставь null вместо числовой оценки и укажи в комментарии "Клиент не предъявлял возражений". 
Этот критерий не должен учитываться в общей оценке.

Также выдели:
- Анализ по этапам разговора (greeting, needs_identification, presentation, objection_handling, closing)
- 3-5 лучших моментов в разговоре с комментариями
- 3-5 моментов, требующих улучшения, с комментариями
- 3-5 конкретных рекомендаций для продажника

Добавь конкретные рекомендации для безошибочного проведения звонков. Для каждого проблемного 
момента предложи альтернативные фразы, которые следовало бы использовать вместо сказанного.

Верни результат строго в формате JSON:
{{
    "analysis": {{
        "greeting": "Анализ приветствия",
        "needs_identification": "Анализ выявления потребностей",
        "presentation": "Анализ презентации продукта",
        "objection_handling": "Анализ работы с возражениями",
        "closing": "Анализ закрытия сделки"
    }},
    "score": {{
        "script_adherence": {{
            "score": 0-10,
            "comment": "Комментарий к оценке"
        }},
        "active_listening": {{
            "score": 0-10,
            "comment": "Комментарий к оценке"
        }},
        "objection_handling": {{
            "score": 0-10 или null,
            "comment": "Комментарий к оценке"
        }},
        "sales_techniques": {{
            "score": 0-10,
            "comment": "Комментарий к оценке"
        }},
        "communication_ethics": {{
            "score": 0-10,
            "comment": "Комментарий к оценке"
        }}
    }},
    "best_moments": [
        {{
            "text": "Цитата из разговора",
            "comment": "Почему это хороший момент"
        }}
    ],
    "worst_moments": [
        {{
            "text": "Цитата из разговора",
            "comment": "Почему это проблемный момент",
            "recommendation": "Конкретная рекомендация, что следовало сказать вместо этого"
        }}
    ],
    "recommendations": [
        "Рекомендация 1",
        "Рекомендация 2"
    ]
}}

Вот транскрипция звонка:
{transcript}
"""